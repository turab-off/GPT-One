{
  "name": "YouTube Analyzer + AI Generator",
  "nodes": [
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "youtube_statistic_videos",
        "limit": 1000,
        "filters": {
          "conditions": [
            {
              "keyName": "processed",
              "condition": "eq",
              "keyValue": "false"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [80, -460],
      "id": "65aa0afc-c615-4af4-92a8-ce71c4b9307a",
      "name": "Supabase",
      "credentials": {
        "supabaseApi": {
          "id": "DauvANnAuHBN382P",
          "name": "Привет от ЮТ канала ИИздец :)"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8",
          "mode": "list",
          "cachedResultName": "Видео конкурентов",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "привет от ИИздец :)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [80, -280],
      "id": "0074577b-06b5-4557-987e-d8d5e5473c8f",
      "name": "Google Sheets",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "LYOUGnmz7GZ6qB6Q",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [340, -360],
      "id": "313e0051-e580-4515-99c6-9aefb2f421e3",
      "name": "Merge",
      "retryOnFail": false
    },
    {
      "parameters": {
        "jsCode": "const supabaseVideos = $input.all(0);\nconst processedSheet = $input.all(1);\n\nconst processedIds = new Set(processedSheet.map(r => r.json.video_id || \"\").filter(id => id && id !== 'dummy'));\n\nconst fresh = supabaseVideos.map(row => ({...row.json, video_id: row.json.video_id || row.json.id})).filter(row => !processedIds.has(row.video_id));\nreturn fresh;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [560, -360],
      "id": "8e5499bc-e600-402c-af91-3f475312759b",
      "name": "Code"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "video_id",
              "value": "={{ $json.video_id }}",
              "type": "string"
            },
            {
              "name": "lang",
              "value": "ru",
              "type": "string"
            },
            {
              "name": "transcript_type",
              "value": "manual",
              "type": "string"
            },
            {
              "name": "api_key",
              "value": "SUDAEGOVOTKNI",
              "type": "string"
            },
            {
              "name": "title",
              "value": "={{ $json.title }}",
              "type": "string"
            },
            {
              "name": "published",
              "value": "={{ $json.published_at }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "9c13f304-a025-4148-8823-a30f3ace89ea",
      "name": "Set Video ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [780, -360]
    },
    {
      "parameters": {
        "unit": "={{ Math.floor(Math.random() * 10000) + 250 }}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1040, -300],
      "id": "4a0c731a-6efa-4975-911c-58abb2b6f184",
      "name": "Wait"
    },
    {
      "parameters": {
        "url": "https://www.searchapi.io/api/v1/search",
        "queryParametersUi": {
          "parameter": [
            {"name":"engine","value":"youtube_transcripts"},
            {"name":"video_id","value":"={{$json['video_id']}}"},
            {"name":"lang","value":"={{$json['lang'] || 'en'}}"},
            {"name":"transcript_type","value":"={{$json['transcript_type'] || 'auto'}}"},
            {"name":"api_key","value":"={{ $json.api_key }}"}
          ]
        }
      },
      "name": "YouTube Transcripts API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1220, -300],
      "id": "152ecabc-adcd-463e-a446-34ce01c9c679"
    },
    {
      "parameters": {
        "functionCode": "return $input.all().map(item => {\n const transcripts = item.json.transcripts || [];\n const cleaned = transcripts.map(t => t.text?.trim()).filter(text => text && !text.match(/^\\[.*\\]$/)).join(' ');\n return {json: {...item.json, transcript: cleaned}};\n});"
      },
      "name": "Process Transcripts",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [-280, 100],
      "id": "cedf2046-5eaa-4679-91fa-890ccf7d7690"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"name":"video_id","value":"={{ $json.search_parameters.video_id }}","type":"string"},
            {"name":"transcript","value":"={{ $json.transcript }}","type":"string"}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [80, 180],
      "id": "9ec969a3-c250-47ba-8f5b-3da695639cd8",
      "name": "Set"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {"content":"=Твоя задача превращать расшифровку видео-роликов короткое саммари (1-3 предложения). Важно чтобы этот текст четко передавал суть, и акцентировал внимание на самой интересной или важной информации из видео. Старайся писать сокращенно, и с максимальной полезностью.\n\nТекст расшифровки:\n{{ $json.transcript }}","role":"system"},
            {"content":"={{ $json.transcript }}"}
          ]
        }
      },
      "id": "c65b8a2e-6603-4224-b7ee-b635186f580f",
      "name": "Summary Agent",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [80, 40],
      "credentials": {"openAiApi":{"id":"qnqNGr4J1V43pQi6","name":"OpenAi NEW"}}
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"name":"summary","value":"={{ $json.message.content }}","type":"string"},
            {"name":"video_id","value":"={{ $('Process Transcripts').item.json.search_parameters.video_id }}","type":"string"},
            {"name":"title","value":"={{ $('Set Video ID').item.json.title }}","type":"string"},
            {"name":"published","value":"={{ $('Set Video ID').item.json.published }}","type":"string"}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [420, 40],
      "id": "0951969a-980f-43ae-914d-3e285db792de",
      "name": "Summary + ID"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "youtube_statistic_video_stat",
        "filters": {"conditions":[{"keyName":"video_id","keyValue":"={{ $('Set').item.json.video_id }}"}]}
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [240, 180],
      "id": "3d946a60-7d94-4285-8bcc-d5104c1bea21",
      "name": "Supabase2",
      "credentials": {"supabaseApi":{"id":"DauvANnAuHBN382P","name":"Привет от ЮТ канала ИИздец :)"}}
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "video_id",
        "joinMode": "keepEverything",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [760, 60],
      "id": "f36664d4-0b6a-471b-8ec4-d879738de892",
      "name": "Merge1"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {"__rl": true,"value": "1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8","mode": "list","cachedResultName": "Видео конкурентов","cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8/edit?usp=drivesdk"},
        "sheetName": {"__rl": true,"value": "gid=0","mode": "list","cachedResultName": "привет от ИИздец :)","cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8/edit#gid=0"},
        "columns": {"mappingMode": "defineBelow","value": {"Summary": "={{ $json.summary }}","video_id": "={{ $json.video_id }}","Title": "={{ $json.title }}","Transcript": "={{ $('Process Transcripts').item.json.transcript }}","Youtube URL": "=https://youtube.com/watch?v={{ $json.video_id }}","Created At": "={{ $now }}","Status": "done","Views": "={{ $json.view_count }}","Likes": "={{ $json.like_count }}","Comments": "={{ $json.comment_count }}","Published": "={{ $json.published }}"},"matchingColumns": [],"schema": []}}
      },
      "id": "94f303e3-fe70-4122-b6a0-ae1b51372aaf",
      "name": "Update Row",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [1000, 60],
      "credentials": {"googleSheetsOAuth2Api":{"id":"LYOUGnmz7GZ6qB6Q","name":"Google Sheets account 2"}}
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "youtube_statistic_videos",
        "filters": {"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.video_id }}"}]},
        "fieldsUi": {"fieldValues":[{"fieldId":"processed","fieldValue":"true"}]}
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1240, 60],
      "id": "3b220db2-5853-4cfe-83ce-db3985847eb4",
      "name": "Processed True",
      "credentials": {"supabaseApi":{"id":"DauvANnAuHBN382P","name":"Привет от ЮТ канала ИИздец :)"}}
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "youtube_statistic_videos",
        "limit": 1000
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-300, -400],
      "id": "ea92a535-2ffb-4b4f-9c86-0c9e0e424e78",
      "name": "Таймер раз в день в 1:30"
    },
    {
      "parameters": {
        "content": "## ПОЛУЧЕНИЕ ID ВИДЕО для ТРАНСКРИБАЦИИ [перевода в текст]",
        "height": 450,
        "width": 1823,
        "color": 3
      },
      "id": "8fda8de3-7794-4d37-8c9a-640754dfd9e0",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-380, -540]
    },
    {
      "parameters": {
        "content": "##  + добавление САММАРИ + СТАТИСТИКИ + обновление таблиц + и статуса в БД",
        "height": 410,
        "width": 1823,
        "color": 6
      },
      "id": "56d591fb-f3ee-4f87-b558-36800586f8c4",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-380, -40]
    },
    {
      "parameters": {
        "content": "Смотри ютуб-канал **ИИздец** > читай тг-канал **AI бля** > и всё будет по кайфу!\n*Обнял.*",
        "height": 110,
        "width": 183,
        "color": 7
      },
      "id": "8c15064c-21d3-4b51-917a-e8d7ba3d383b",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-7500, 2900]
    },
    {
      "parameters": {
        "modelId": {"__rl": true,"value": "gpt-4o","mode": "list","cachedResultName": "GPT-4O"},
        "messages": {"values": [
          {"content": "=На основе саммари и статистики определи, почему это видео стало популярным. Оцени заголовок, тему, эмоции, формат и призыв к действию. Ответь кратко.","role": "system"},
          {"content": "Summary: {{ $json.summary }}. Title: {{ $json.title }}. Views: {{ $json.view_count }}. Likes: {{ $json.like_count }}. Comments: {{ $json.comment_count }}."}
        ]}
      },
      "id": "success-analysis-agent",
      "name": "Success Analysis Agent",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [900, 180],
      "credentials": {"openAiApi":{"id":"qnqNGr4J1V43pQi6","name":"OpenAi NEW"}}
    },
    {
      "parameters": {
        "assignments": {"assignments": [{"name":"success_reason","value":"={{ $json.message.content }}","type":"string"}]},
        "options": {}
      },
      "id": "set-success",
      "name": "Set Success Reason",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1080, 180]
    },
    {
      "parameters": {
        "modelId": {"__rl": true,"value": "gpt-4o","mode": "list","cachedResultName": "GPT-4O"},
        "messages": {"values": [
          {"content": "=Сгенерируй идею для короткого ролика. Верни JSON с полями: generated_title, script, segments, cta, description, hashtags.","role": "system"},
          {"content": "={{ $json.success_reason }}"}
        ]}
      },
      "id": "video-idea-agent",
      "name": "Video Idea Agent",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [1260, 180],
      "credentials": {"openAiApi":{"id":"qnqNGr4J1V43pQi6","name":"OpenAi NEW"}}
    },
    {
      "parameters": {
        "dataPropertyName": "message.content"
      },
      "type": "n8n-nodes-base.jsonParse",
      "typeVersion": 1,
      "position": [1440, 180],
      "id": "parse-idea",
      "name": "Parse Idea"
    },
    {
      "parameters": {
        "assignments": {"assignments": [
          {"name":"generated_title","value":"={{ $json.generated_title }}","type":"string"},
          {"name":"script","value":"={{ $json.script }}","type":"string"},
          {"name":"segments","value":"={{ $json.segments }}","type":"string"},
          {"name":"cta","value":"={{ $json.cta }}","type":"string"},
          {"name":"description","value":"={{ $json.description }}","type":"string"},
          {"name":"hashtags","value":"={{ $json.hashtags }}","type":"string"}
        ]},
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1620, 180],
      "id": "set-idea"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {"__rl": true,"value": "1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8","mode": "list","cachedResultName": "Видео конкурентов","cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8/edit?usp=drivesdk"},
        "sheetName": {"__rl": true,"value": "gid=123456","mode": "list","cachedResultName": "Video Ideas","cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b9BH4R3Kn4Hyq07RQ5oVNmuSZd3WMHruISPvYHDrQA8/edit#gid=123456"},
        "columns": {"mappingMode": "defineBelow","value": {"Video ID":"={{ $('Summary + ID').item.json.video_id }}","Success Reason":"={{ $('set-success').item.json.success_reason }}","Generated Title":"={{ $json.generated_title }}","Script":"={{ $json.script }}","Segments":"={{ $json.segments }}","CTA":"={{ $json.cta }}","Description":"={{ $json.description }}","Hashtags":"={{ $json.hashtags }}"},"matchingColumns": [],"schema": []}}
      },
      "id": "idea-sheet",
      "name": "Save Idea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [1800, 180],
      "credentials": {"googleSheetsOAuth2Api":{"id":"LYOUGnmz7GZ6qB6Q","name":"Google Sheets account 2"}}
    }
  ],
  "connections": {
    "Supabase": {"main": [[{"node":"Merge","type":"main","index":0}]]},
    "Google Sheets": {"main": [[{"node":"Merge","type":"main","index":1}]]},
    "Merge": {"main": [[{"node":"Code","type":"main","index":0}]]},
    "Code": {"main": [[{"node":"Set Video ID","type":"main","index":0}]]},
    "Set Video ID": {"main": [[{"node":"Wait","type":"main","index":0}]]},
    "Wait": {"main": [[{"node":"YouTube Transcripts API","type":"main","index":0}]]},
    "YouTube Transcripts API": {"main": [[{"node":"Process Transcripts","type":"main","index":0}]]},
    "Process Transcripts": {"main": [[{"node":"Set","type":"main","index":0},{"node":"Summary Agent","type":"main","index":0}]]},
    "Set": {"main": [[{"node":"Supabase2","type":"main","index":0}]]},
    "Supabase2": {"main": [[{"node":"Merge1","type":"main","index":1}]]},
    "Summary Agent": {"main": [[{"node":"Summary + ID","type":"main","index":0}]]},
    "Summary + ID": {"main": [[{"node":"Merge1","type":"main","index":0}]]},
    "Merge1": {"main": [[{"node":"success-analysis-agent","type":"main","index":0}]]},
    "success-analysis-agent": {"main": [[{"node":"set-success","type":"main","index":0}]]},
    "set-success": {"main": [[{"node":"video-idea-agent","type":"main","index":0}]]},
    "video-idea-agent": {"main": [[{"node":"parse-idea","type":"main","index":0}]]},
    "parse-idea": {"main": [[{"node":"set-idea","type":"main","index":0}]]},
    "set-idea": {"main": [[{"node":"idea-sheet","type":"main","index":0},{"node":"Update Row","type":"main","index":0}]]},
    "Update Row": {"main": [[{"node":"Processed True","type":"main","index":0}]]}
  },
  "active": false,
  "settings": {"executionOrder":"v1"},
  "versionId": "43077a40-2681-4abe-bef2-bd3d8c971529"
}
